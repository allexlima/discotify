name: Validate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate manifest.json
        run: |
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));

            // Validate required fields
            const required = ['manifest_version', 'name', 'version', 'description'];
            for (const field of required) {
              if (!manifest[field]) {
                console.error(\`Missing required field: \${field}\`);
                process.exit(1);
              }
            }

            // Validate version format (semantic versioning)
            const versionRegex = /^\d+\.\d+\.\d+$/;
            if (!versionRegex.test(manifest.version)) {
              console.error(\`Invalid version format: \${manifest.version}. Must be X.Y.Z\`);
              process.exit(1);
            }

            // Validate manifest_version
            if (manifest.manifest_version !== 3) {
              console.error(\`Expected manifest_version 3, got \${manifest.manifest_version}\`);
              process.exit(1);
            }

            console.log('✅ manifest.json is valid');
            console.log(\`   Name: \${manifest.name}\`);
            console.log(\`   Version: \${manifest.version}\`);
            console.log(\`   Description: \${manifest.description}\`);
          "

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Check code formatting
        run: npx prettier --check src/
        continue-on-error: true

      - name: Validate file structure
        run: |
          # Check required files exist
          REQUIRED_FILES=(
            "manifest.json"
            "src/background/background.js"
            "src/content/content.js"
            "src/popup/popup.html"
            "src/popup/popup.js"
            "README.md"
            "LICENSE"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
          done

          echo "✅ All required files present"

      - name: Check for large files
        run: |
          # Find files larger than 1MB (excluding node_modules)
          LARGE_FILES=$(find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*")

          if [ -n "$LARGE_FILES" ]; then
            echo "⚠️  Warning: Large files detected:"
            echo "$LARGE_FILES"
          else
            echo "✅ No large files found"
          fi
